<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <style>
      body,
      html {
          margin:0;
          padding:0;
          color:#000;
          font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
          font-size: 1em; /* 1em=16px */

      }
      #wrap {
          width:900px;
          margin:0 auto;
      }
      #header {
          padding:5px 10px;
      }
      #nav {
          padding:5px 10px;
      }
      #main {
          float:left;
          width:575px;
          padding:10px;
          background:#F0F0F0;
      }
      #sidebar {
          float:right;
          width:230px;
          padding:10px;
      }
      #footer {
          clear:both;
          padding:5px 10px;
          #background:#cc9;
      }
      #nav ul {
          margin:0;
          padding:0;
          list-style:none;
      }
      #nav li {
          display:inline;
          margin:0;
          padding:0;
      }
      h1 {
          margin:0;
      }
      #chart_title {
          margin:0 0 1em;
          color: black;
          text-align: center;
      }
      #chart_title em {
          color: red;
      }
      #footer p {
          margin:0;
      }
      * html #footer {
          height:1px;
      }
      path {
          fill: none;
          stroke: black;
          stroke-width: 2px;
      }
      .tick {
          fill: none;
          stroke: black;
      }
      circle {
          r: 4px;
          stroke: none;
      }
      line {
          fill: none;
          stroke-width: 1px;
        }
      .year_select {
          background:#F0F0F0;
          font-size: 1em;
          display: none;
      }
      .hdi_select,.gdp_select {
          background:#F0F0F0;
          font-size: 1em;
          display: none;
      }

      .alignleft {
          float: left;
      }
      .alignright {
          float: right;
      }
      .tooltip {
          color: #333;
          background: #eee;
          box-shadow: 0 0 5px #999999;
          margin: 0px;
          padding: 5px;
          width: 150px;
          font-size: 0.75em;
          line-height: 0.25em;
          position: absolute;
          display: none;
      }
    </style>
    <script type="text/javascript">
      format = d3.time.format("%d-%m-%Y (%H:%M h)");
	  // Draw a slope plot from the gdp_data. The left half of the
	  // plot displays the GDP of the countries and the right half of
	  // the plot displays the HDI of the countries. Color the
	  // connecting lines between GDP and HDI of the same same country
	  // according to the discrepancy beween GDP and HDI - color them one
	  // way when GDP is higher and the other way when the HDI is higher.
      function draw(gdp_data) {

          "use strict";
          // D3.js setup code 
          var rank_diff_threshold = 30;
          var margin = {top: 40, right: 20, bottom: 30, left: 60},
          width = 350 - margin.left - margin.right,
          height = 700 - margin.top - margin.bottom;
          var left_indicator = 'GDP';
          var right_indicator = 'HDI';
		  var hdi_color = '#151B54';
		  //var hdi_color = '#0068af';
		  //var hdi_color = '#dc3835';
		  var gdp_color = '#dc3815';
		  var neutral_color = '#AAAAAA';
          var svg = d3.select("body #wrap #main")
              .append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append('g')
              .attr('class', 'chart');

          var left_extent = d3.extent(gdp_data, function(d) {
              return d[left_indicator];
          });
          var left_scale = d3.scale.linear()
              .domain(left_extent)
              .range([height-margin.top, margin.bottom]);

          var right_extent = d3.extent(gdp_data, function(d) {
              return d[right_indicator];
          });
          var right_scale = d3.scale.linear()
              .domain(right_extent)
              .range([height-margin.top, margin.bottom]);

          var years_set = d3.set();
          gdp_data.forEach(function(d) {
              years_set.add(d['Year']);
          });
          var years = [];
          years_set.forEach(function(d) {
              years.push(+d);
          });          
          var time_extent = d3.extent(gdp_data, function(d) {
              return d['Year'];
          });
          var time_scale = d3.time.scale()
              .range([margin.left, width])
              .domain(time_extent);

          function key_country_year(d) {
              return d['Country_Name']+d['Year'];
          }
          function key_country(d) {
              return d['Country_Name'];
          }
          function key_all(d) {
              return d;
          }

          function is_missing(d) {
              return d == null
          }
          var left_x = margin.left;
          function left_y(d) {
              return left_scale(d[left_indicator])
          }
          var right_x = width-margin.right;
          function right_y(d) {
              return right_scale(d[right_indicator])
          }
          function slope_color(d) {
              var color = neutral_color;
			  if (d['GDP'] > d['HDI']) {
                  color = gdp_color;
			  } else if (d['GDP'] < d['HDI']) {
                  color = hdi_color;
			  } 
              return color;              
          }
          function display_style(d) {
              var ds = is_missing(d[left_indicator])||is_missing(d[right_indicator]) ?
                  "none" : null;
              return ds;
          }
          var circle_tip = d3.select("body #wrap #main")
              .append("div")
              .attr("class", "tooltip");
          circle_tip.append('div')
              .attr('class', 'country');
          circle_tip.append('div')
              .style('clear', 'both');
          circle_tip.append('div')
              .attr('class', 'indicator');
          circle_tip.append('div')
              .style('clear', 'both');
          function show_left_tip(d) {
              circle_tip.select('.country').html(
                  "<p class=\"alignleft\"><strong>Country:</strong><\p> <p class=\"alignright\">"+d.Country_Name+"</p>");
              circle_tip.select('.indicator').html(
                  "<p class=\"alignleft\"><strong>GDP:</strong><\p> <p class=\"alignright\">"+d.GDP+"</p>");
              circle_tip.style('display', 'block');
          }
          function show_right_tip(d) {
              circle_tip.select('.country').html(
                  "<p class=\"alignleft\"><strong>Country:</strong><\p> <p class=\"alignright\">"+d.Country_Name+"</p>");
              circle_tip.select('.indicator').html(
                  "<p class=\"alignleft\"><strong>HDI:</strong><\p> <p class=\"alignright\">"+d.HDI+"</p>");
              circle_tip.style('display', 'block');
          }
          function track_tip(d) {
              var py = d3.event.pageY;
              var px = d3.event.pageX;
              circle_tip.style('top', (py+1) + 'px');
              circle_tip.style('left', (px+7) + 'px');
          }
          function hide_tip(d) {
              circle_tip.style('display', 'none');
          }
          function update_yearly_data(year, rank_diff_threshold) {
              function update_country_data(country) {
                  var country_data = yearly_data.filter(function(d) {
                      return d['Country_Name'] === country;
                  });
                  // update current lines and circles, and fade others
                  svg.selectAll("line")
                      .data(country_data, key_country)
                      .style("opacity", 1)            // update current line
                      .exit().style("opacity", 0.1); // fade other lines
                  svg.selectAll("circle.left_circle")
                      .data(country_data, key_country)
                      .style("opacity", 1)            // update current circle
                      .exit().style("opacity", 0.1)   // fade other circles
                  svg.selectAll("circle.right_circle")
                      .data(country_data, key_country)
                      .style("opacity", 1)            // update current circle
                      .exit().style("opacity", 0.1);  // fade other circles
              }
			  function update_country_list(select_header, select_list, 
										   select_countries, select_color){
				  if(select_countries.length == 0) {
					  select_header.style('display', 'none');
					  select_list.style('display', 'none');
				  } else {
					  select_list.selectAll("option").remove();
					  var select_options = select_list.selectAll("option")
						  .data(select_countries, key_all);
					  select_options.enter().append("option")
						  .attr("value", function(d) {
							  return d;
						  })
						  .text(function(d) {
							  return d;
						  });
					  select_header.style('display', 'block');
					  select_header.style('color', select_color);
					  select_list.style('display', 'block');
					  select_list.style('color', select_color);
					  // handle on click event
					  select_list.on('change', function() {
						  var selected_country = d3.select(this).property('value');
						  update_country_data(selected_country);
					  });
				  }
			  }

              var yearly_data = gdp_data.filter(function(d) {
                  var rank_diff = d['HDI']-d['GDP'];
                  var in_threshold = (rank_diff < -1 * rank_diff_threshold) ||
                      (rank_diff > rank_diff_threshold);
                  return (d['Year'] === year) && in_threshold;
              });

              var hdi_countries = [], gdp_countries = [];
              yearly_data.forEach(function(d) {
				  var country = d['Country_Name'];
                  var rank_diff = d['GDP']-d['HDI'];
				  if (d['GDP'] > d['HDI']) {
					  gdp_countries.push(country);
				  } else {
					  hdi_countries.push(country);
				  }
              }); 
              gdp_countries.sort(); hdi_countries.sort();
			  var country_count = gdp_countries.length + hdi_countries.length;
              d3.select("#chart_title")
                  .html("In <em>"+year+"</em>, GDP rankings of <em>"+country_count+ "</em> countries differed from their HDI rankings by 30 or more positions");
              var lines = svg.selectAll("line")
                  .data(yearly_data, key_country_year);

              lines.exit().remove();
              lines.enter()
                  .append("line")
                  .attr("x1", left_x)
                  .attr("y1", left_y)
                  .attr("x2", right_x)
                  .attr("y2", right_y) 
                  .attr("stroke", slope_color);

              var left_circles = svg.selectAll("circle.left_circle")
                  .data(yearly_data, key_country_year);
              left_circles.exit().remove();
              left_circles.enter()
                  .append("circle")
                  .attr('class', 'left_circle')
                  .attr("cx", left_x)
                  .attr("cy", left_y)
                  .attr("fill", slope_color)
                  .on('mouseover', show_left_tip)
                  .on('mouseout', hide_tip)
                  .on('mousemove', track_tip);
                                         
              var right_circles = svg.selectAll("circle.right_circle")
                  .data(yearly_data, key_country_year);
              right_circles.exit().remove();
              right_circles.enter()
                  .append("circle")
                  .attr('class', 'right_circle')
                  .attr("cx", right_x)
                  .attr("cy", right_y)
                  .attr("fill", slope_color)
                  .on('mouseover', show_right_tip)
                  .on('mouseout', hide_tip)
                  .on('mousemove', track_tip);

			  // Show country select drop down lists on the side bar
              var hdi_header = d3.select("#sidebar .hdi_select_header");
              var hdi_list = d3.select("#sidebar .hdi_select");
			  update_country_list(hdi_header, hdi_list, hdi_countries, hdi_color);

              var gdp_header = d3.select("#sidebar .gdp_select_header");
              var gdp_list = d3.select("#sidebar .gdp_select");
			  update_country_list(gdp_header, gdp_list, gdp_countries, gdp_color);

          }
          //update_yearly_data(2011, rank_diff_threshold);
          var year_idx = 0;
          var year_interval = setInterval(function() {
			  var current_year = years[year_idx];
              update_yearly_data(current_year, rank_diff_threshold);
              year_idx++;
              if(year_idx >= years.length) {
                  clearInterval(year_interval);
                  var year_selection = d3.select("#sidebar .year_select");
                  year_selection.style('display', 'block');
                  var year_options = year_selection.selectAll("option")
                      .data(years)
                      .enter()
                      .append("option")
                      .attr("value", function(d) {
                          return d;
                      })
                      .text(function(d) {
                          return d;
                      })
				      .each(function(d) {
						  debugger;
						  if(d==current_year) {
							  d3.select(this).attr("selected", "selected");
						  }
					  });

                  // handle on click event
                  year_selection.on('change', function() {
                      var year = +d3.select(this).property('value');
                      update_yearly_data(year, rank_diff_threshold);
                  });
              }
          }, 1000);
      };
    </script>
  </head>
<body>
    <div id="wrap">
      <div id="header"><h1>Do GDP and HDI tell the same story ?</h1></div>
      <div id="nav"></div>
      <div id="main">
        <h2 id="chart_title">
        </h2>
        <div>
          <span><strong>GDP Rank</strong></span>
          &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
          &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
          &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
          <span><strong>HDI Rank</strong></span>
        </div>
        <script type="text/javascript">
          /* Load CSV file and pass the contents of it to the draw function */
          var left_indicator = 'GDP'
          var right_indicator = 'HDI'
          d3.csv("rdata.csv", function(d) {
          d['Year'] = +d['Year'];
          d[right_indicator] = +d[right_indicator];
          d[left_indicator] = +d[left_indicator];
          return d;
          }, draw);
        </script>
      </div>
      <div id="sidebar">
        <fieldset>
          <legend>Relation:</legend> 
          <span style="color:#0068af;font-size:1.5em">
            <b>&#8599</b>
          </span> Countries whose HDI rank is higher than GDP rank <br><br>
          <span style="color:#dc3835;font-size:1.5em">
            <b>&#8600</b>
          </span> Countries whose GDP rank is higher than HDI rank
        </fieldset>
        <br>
        <br>
        <div>
          <div class="hdi_select_header"> <strong> Click a <b>&#8599</b> country to highlight </strong> </div>
          <select class="hdi_select">
          </select>
        </div>
        <br>
        <div>
          <div class="gdp_select_header"> <strong> Click a <b>&#8600</b> country to highlight </strong> </div>
          <select class="gdp_select">
          </select>
        </div>
        <br>
        <div>
          <div> <strong> Click a year to select </strong> </div>
          <select class="year_select">
          </select>
        </div>
      </div>
      <div id="footer">
      </div>
    </div>
</body>
</html>
