<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <style>
	    body {
			font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif
			font-size: 1em; /* 1em=16px */
		}
		h2 { 
			font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif
			color: black;
			text-align: center;
		   }
		path {
			fill: none;
			stroke: black;
			stroke-width: 2px;
		}
		
		.tick {
			fill: none;
			stroke: black;
		}
		
		circle {
			r: 4px;
			stroke: none;
		}
		
		line {
			fill: none;
			stroke-width: 2px;
		}
		.alignleft {
			float: left;
		}
		.alignright {
			float: right;
		}
		div.years_buttons {
			position: fixed;
			top: 5px;
			left: 50px;
		}
		
		div.years_options div {
			background-color: rgb(251, 201, 127);
			padding: 3px;
			margin: 7px;
		}
		.tooltip {
			font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif
			color: #333;
			background: #eee;
			box-shadow: 0 0 5px #999999;
			margin: 0px;
			padding: 5px;
			width: 150px;
			font-size: 0.75em;
			line-height: 0.25em;
			position: fixed;
			display: none;
		}
	</style>
    <script type="text/javascript">
      format = d3.time.format("%d-%m-%Y (%H:%M h)");
      function draw(data) {
          /* D3.js setup code */
          "use strict";
		  var margin = {top: 40, right: 20, bottom: 30, left: 160},
		  width = 1000 - margin.left - margin.right,
		  height = 500 - margin.top - margin.bottom;
          //var margin = 75,
          //    width = 1400 - margin,
          //    height = 600 - margin;
		  var left_indicator = 'GDP'
		  var right_indicator = 'HDI'
          d3.select("body")
              .append("h2")
              .text("Relation between Gross Domestic Product (GDP) and Human Development Index (HDI) ");

          var svg = d3.select("body")
              .append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append('g')
              .attr('class', 'chart');

          var circle_tip = d3.select("body")
              .append('div')
              .attr('class', 'tooltip')
		  circle_tip.append('div')
              .attr('class', 'country');
          circle_tip.append('div')
              .style('clear', 'both');
          circle_tip.append('div')
              .attr('class', 'indicator');
          circle_tip.append('div')
              .style('clear', 'both');

          var left_extent = d3.extent(data, function(d) {
              return d[left_indicator];
          });
          var left_scale = d3.scale.linear()
              .domain(left_extent)
              .range([height-margin.top, margin.bottom]);

          var right_extent = d3.extent(data, function(d) {
              return d[right_indicator];
          });
          var right_scale = d3.scale.linear()
              .domain(right_extent)
              .range([height-margin.top, margin.bottom]);

          var years_set = d3.set();
          data.forEach(function(d) {
              years_set.add(d['Year']);
          });
          var years = [];
          years_set.forEach(function(d) {
			  years.push(+d);
		  });		  
          var time_extent = d3.extent(data, function(d) {
              return d['Year'];
          });
          var time_scale = d3.time.scale()
              .range([margin.left, width])
              .domain(time_extent);

          function key_func(d) {
              return d['Country_Name']+d['Year'];
          }

		  function is_missing(d) {
			  return d == null
		  }
		  var left_x = margin.left;
		  function left_y(d) {
			  return left_scale(d[left_indicator])
		  }
		  var right_x = width-margin.right;
		  function right_y(d) {
			  return right_scale(d[right_indicator])
		  }
		  function slope_color(d) {
			  var y1 = left_y(d);
			  var y2 = right_y(d);
			  var color = 'black';
			  if (y1 == y2) {
				  color = 'black';
			  } else if (y1 > y2) {
				  color = '#CC0000';
			  } else if (y1 < y2) {
				  color = '#6699FF';
			  }
			  return color;			  
		  }
		  function display_style(d) {
			  var ds = is_missing(d[left_indicator])||is_missing(d[right_indicator]) ?
				  "none" : null;
			  return ds;
		  }
		  function show_left_tip(d) {
			  circle_tip.select('.country').html(
				  "<p class=\"alignleft\"><strong>Country:</strong><\p> <p class=\"alignright\">"+d.Country_Name+"</p>");
			  circle_tip.select('.indicator').html(
				  "<p class=\"alignleft\"><strong>GDP:</strong><\p> <p class=\"alignright\">"+d.GDP+"</p>");
			  circle_tip.style('display', 'block');
		  }
		  function show_right_tip(d) {
			  circle_tip.select('.country').html(
				  "<p class=\"alignleft\"><strong>Country:</strong><\p> <p class=\"alignright\">"+d.Country_Name+"</p>");
			  circle_tip.select('.indicator').html(
				  "<p class=\"alignleft\"><strong>HDI:</strong><\p> <p class=\"alignright\">"+d.HDI+"</p>");
			  circle_tip.style('display', 'block');
		  }
		  function track_tip(d) {
			  var px = d3.event.pageX,
			  py = d3.event.pageY;
			  circle_tip.style('top', (py+10) + 'px');
			  circle_tip.style('left', (px+10) + 'px');
		  }
		  function hide_tip(d) {
			  circle_tip.style('display', 'none');
		  }
          function update(year) {
              d3.select("h2")
                .text("Relation between Gross Domestic Product (GDP) and Human Development Index (HDI) " + year);

              var yearly_data = data.filter(function(d) {
                  return d['Year'] === year;
              });
			  var lines = svg.selectAll("line")
				  .data(yearly_data, key_func);
			  lines.exit().remove();
			  lines.enter()
				  .append("line")
				  .attr("x1", left_x)
				  .attr("y1", left_y)
				  .attr("x2", right_x)
				  .attr("y2", right_y) 
			      .attr("stroke", slope_color)
			      .style("display", display_style);

			  var left_circles = svg.selectAll("circle.left_circle")
				  .data(yearly_data, key_func);
			  left_circles.exit().remove();
			  left_circles.enter()
				  .append("circle")
				  .attr('class', 'left_circle')
				  .attr("cx", left_x)
				  .attr("cy", left_y)
			      .attr("fill", slope_color)
			      .style("display", display_style)
				  .on('mouseover', show_left_tip)
				  .on('mouseout', hide_tip)
				  .on('mousemove', track_tip);
										 
			  var right_circles = svg.selectAll("circle.right_circle")
				  .data(yearly_data, key_func);
			  right_circles.exit().remove();
			  right_circles.enter()
				  .append("circle")
				  .attr('class', 'right_circle')
				  .attr("cx", right_x)
				  .attr("cy", right_y)
			      .attr("fill", slope_color)
			      .style("display", display_style)
				  .on('mouseover', show_right_tip)
				  .on('mouseout', hide_tip)
				  .on('mousemove', track_tip);

          }
		  //update(2009);
		  var year_idx = 0;
		  var year_interval = setInterval(function() {
			  update(years[year_idx]);
			  year_idx++;
			  if(year_idx >= years.length) {
				  clearInterval(year_interval);
				  
				  var buttons = d3.select("body")
					  .append("div")
					  .attr("class", "years_buttons")
					  .selectAll("div")
					  .data(years)
					  .enter()
					  .append("div")
					  .text(function(d) {
						  return d;
					  });
				  
				  buttons.on("click", function(d) {
					  d3.select(".years_buttons")
						  .selectAll("div")
						  .transition()
						  .duration(500)
						  .style("color", "black")
						  .style("background", "rgb(251, 201, 127)");
					  
					  d3.select(this)
						  .transition()
						  .duration(500)
						  .style("background", "lightBlue")
						  .style("color", "white");
					  update(d);
				  });
			  }
		  }, 1000);
      };
    </script>
  </head>
<body>
  <script type="text/javascript">
      /* Load CSV file and pass the contents of it to the draw function */
	  var left_indicator = 'GDP'
	  var right_indicator = 'HDI'
      d3.csv("gdp_hdi_data.csv", function(d) {
          d['Year'] = +d['Year'];
          d[right_indicator] = +d[right_indicator];
          d[left_indicator] = +d[left_indicator];
          return d;
      }, draw);
  </script>
</body>
</html>
